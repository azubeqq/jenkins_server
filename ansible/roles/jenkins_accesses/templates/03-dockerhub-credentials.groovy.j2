#!groovy

import jenkins.model.*
import com.cloudbees.plugins.credentials.*
import com.cloudbees.plugins.credentials.domains.*
import com.cloudbees.plugins.credentials.impl.*
import com.cloudbees.plugins.credentials.common.*
import hudson.util.Secret

println "=== Starting DockerHub credentials setup ==="

def instance = Jenkins.getInstance()

def dockerhubCredId = "dockerhub-credentials"

// Подставляется через Jinja2
def dockerhubUsername = "{{ dockerhub_username }}"
def dockerhubToken = "{{ dockerhub_token }}"

if (dockerhubUsername == null || dockerhubUsername.isEmpty()) {
    println "ERROR: DockerHub username is empty!"
    return
}

if (dockerhubToken == null || dockerhubToken.isEmpty()) {
    println "ERROR: DockerHub token is empty!"
    return
}

println "Adding credentials with ID: ${dockerhubCredId}"

def globalDomain = Domain.global()
def credentialStore = instance.getExtensionList(
    'com.cloudbees.plugins.credentials.SystemCredentialsProvider'
)[0].getStore()

// Используем UsernamePasswordCredentialsImpl - он ВСЕГДА доступен
def dockerhubCred = new UsernamePasswordCredentialsImpl(
    CredentialsScope.GLOBAL,
    dockerhubCredId,
    "DockerHub Credentials (username + token)",
    dockerhubUsername,
    dockerhubToken
)

// Проверяем существование
def existing = com.cloudbees.plugins.credentials.CredentialsProvider.lookupCredentials(
    UsernamePasswordCredentials.class,
    Jenkins.instance
).find { it.id == dockerhubCredId }

if (existing == null) {
    credentialStore.addCredentials(globalDomain, dockerhubCred)
    println "✓ DockerHub credentials added: ${dockerhubCredId}"
    println "  Username: ${dockerhubUsername}"
} else {
    println "! DockerHub credentials already exist: ${dockerhubCredId}"
}

instance.save()
println "=== DockerHub credentials configuration completed ==="