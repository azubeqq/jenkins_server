    # ========== TERRAFORM ==========
- name: Install Terraform dependencies
  ansible.builtin.dnf:
    name: "{{ terraform_dependencies }}"
    state: present

- name: Check if HashiCorp repository exists
  ansible.builtin.stat:
    path: /etc/yum.repos.d/hashicorp.repo
  register: hashicorp_repo

- name: Add HashiCorp repository
  ansible.builtin.command: yum-config-manager --add-repo "{{ terraform_repo_url }}"      
  when: not hashicorp_repo.stat.exists
  changed_when: true

- name: Install Terraform
  ansible.builtin.dnf:
    name: terraform
    state: present

- name: Verify Terraform installation
  ansible.builtin.command: terraform --version
  register: terraform_version
  changed_when: false

- name: Display Terraform version
  ansible.builtin.debug:
    msg: "Installed: {{ terraform_version.stdout_lines[0] }}"

# roles/jenkins/tasks/main.yml (или roles/terraform/tasks/main.yml)

- name: Create Terraform plugin cache directory
  ansible.builtin.file:
    path: /var/lib/jenkins/.terraform.d/plugin-cache
    state: directory
    owner: jenkins
    group: jenkins
    mode: '0755'

- name: Configure Terraform to use plugin cache
  ansible.builtin.copy:
    content: |
      plugin_cache_dir = "$HOME/.terraform.d/plugin-cache"
      disable_checkpoint = true
    dest: /var/lib/jenkins/.terraformrc
    owner: jenkins
    group: jenkins
    mode: '0644'

- name: Create Jenkins tmp directory (avoid tmpfs issues)
  ansible.builtin.file:
    path: /var/lib/jenkins/tmp
    state: directory
    owner: jenkins
    group: jenkins
    mode: '0755'

- name: Set TMPDIR for Jenkins service
  ansible.builtin.copy:
    content: |
      [Service]
      Environment="TMPDIR=/var/lib/jenkins/tmp"
    dest: /etc/systemd/system/jenkins.service.d/override.conf
    mode: '0644'
  notify: restart jenkins

- name: Reload systemd daemon
  ansible.builtin.systemd:
    daemon_reload: yes