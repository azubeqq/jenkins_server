# ansible/roles/ansible/tasks/main.yml
---
    # ========== ANSIBLE ==========
# Установка Python нужной версии
- name: "Install Python {{ target_python_version }} and Pip"
  ansible.builtin.dnf:
    name:
      - "{{ python_package_name }}"
      - "{{ python_pip_package_name }}"
    state: present

# Очистка старой версии (опционально, но полезно для чистоты)
- name: Remove old Ansible installed via system default pip
  ansible.builtin.pip:
    name: ansible
    state: absent
    executable: pip3
  ignore_errors: true # Игнорируем, если там ничего не было

# Установка библиотек AWS в НУЖНЫЙ Python
- name: "Install Python AWS libraries for Python {{ target_python_version }}"
  ansible.builtin.pip:
    name:
      - boto3
      - botocore
    executable: "{{ pip_executable }}" # Используем pip3.11
    state: present

# Установка свежего Ansible
- name: "Install Ansible (>= {{ ansible_pypi_version }}) via {{ pip_executable }}"
  ansible.builtin.pip:
    name: "ansible>={{ ansible_pypi_version }}"
    state: present
    executable: "{{ pip_executable }}" # Используем pip3.11

# Создание симлинка, чтобы команда 'ansible' работала без указания полного пути
# pip3.11 на Amazon Linux обычно ставит бинарники в /usr/local/bin
- name: Ensure ansible symlink exists in /usr/bin
  ansible.builtin.file:
    src: /usr/local/bin/ansible
    dest: /usr/bin/ansible
    state: link
    force: yes

# Установка коллекций для jenkins
- name: Install Ansible collections for jenkins user
  ansible.builtin.command: ansible-galaxy collection install {{ item }} --force
  loop: "{{ ansible_collections }}"
  become: yes
  become_user: jenkins  # ← ГЛАВНОЕ ИЗМЕНЕНИЕ!
  register: galaxy_result
  changed_when: "'was installed successfully' in galaxy_result.stdout"
  failed_when:
    - galaxy_result.rc != 0
    - "'is already installed' not in galaxy_result.stderr"

- name: Create Ansible configuration directory
  ansible.builtin.file:
    path: "{{ ansible_config_path | dirname }}"
    state: directory
    mode: '0755'
  when: ansible_config_create

- name: Deploy ansible.cfg from template
  ansible.builtin.template:
    src: ansible.cfg.j2
    dest: "{{ ansible_config_path }}"
    mode: '0644'
  when: ansible_config_create

- name: Verify Ansible installation
  ansible.builtin.command: ansible --version
  register: ansible_version_output
  changed_when: false
  when: ansible_verify_installation
